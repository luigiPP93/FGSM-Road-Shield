<!--
    This is the index.html file for the FGSM Road Shield web application.
    It contains the HTML structure and elements for the user interface.

    The file includes the necessary CSS and JavaScript libraries, as well as the custom styles and scripts.

    The main content of the page includes a header with the application title, and a main section with three input fields:
    - Attack Type: A dropdown menu to select the type of attack.
    - Traffic Sign: A dropdown menu to select the traffic sign.
    - Perturbation Level: A range input to select the perturbation level.

    The selected values from these input fields will be used for generating the FGSM Road Shield.

    The file also includes a loop to dynamically populate the Traffic Sign dropdown menu with options based on a list of signs.

    Note: This is a partial code snippet and may not include the complete HTML structure of the page.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>FGSM Road Shield</title>
</head>
<body>
    <header class="text-center">
         <h1 class="poetsen-one-regular">FGSM Road Shield</h1>
    </header>

    <main>
        <div class="container">
            <!-- Prima riga per i tre input -->
            <div class="row mb-3 d-flex justify-content-center">
                <div class="col-md-3 d-flex flex-column align-items-center">
                    <label for="attack-type" class="form-label">Select Attack Type:</label>
                    <select id="attack-type" class="form-control custom-select">
                        <option value="FGSM">FGSM</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex flex-column align-items-center">
                    <label for="signs" class="form-label">Select Traffic Sign:</label>
                    <select id="signs" name="signs" class="form-control custom-select">
                        {% for sign in list_signs %}
                        <option value="{{ sign }}">{{ sign }}</option>
                        {% endfor %}
                    </select>                    
                </div>
                <div class="col-md-3 d-flex flex-column align-items-center">
                    <label for="perturbation-level" class="form-label">Select perturbation level:</label>
                    <input type="range" class="form-range" id="range" min="0" max="1" step="0.01" value="0.04" oninput="updateRangeValue(this.value)">
                    <div class="range-value-container">
                        <span id="range-value">0.04</span>
                    </div>
                </div>
                              
            </div>
    
            <!-- 
                This HTML code represents the main content of the index page.
                It contains a row with three columns, each containing different elements related to image processing and prediction.
                The first column displays the original image and allows the user to upload a new image.
                The second column contains a button to apply an intrusion to the image.
                The third column displays the intruded image and shows the prediction results.
                Below the row, there are two additional buttons for predicting the result and predicting with a defense model.
            -->
            <div class="row d-flex justify-content-center mt-5">
                <div class="col-md-4 d-flex flex-column align-items-center">
                    <h2 class="fs-3 text-center">Original Image:</h2>                
                    <div class="image-container placeholder" style="width: 200px; height: 200px; overflow: hidden;">
                        <img id="preview1" src="static/img/noimg.png" alt="Image preview" style="width: 100%; height: 100%; object-fit: cover;" class="img-fluid">
                    </div>
                    <input type="file" id="image1" class="form-control-sm mt-2" accept=".jpg, .jpeg, .png" onchange="previewImage('image1', 'preview1')">
                    <div id="prediction-result-base" class="m-2"></div>
                    <div id="error-message" class="text-danger mt-2" style="display: none;"></div>
                    <div class="d-flex justify-content-center my-3">
                        <div class="" id="loadingSpinnerPredictionBase" style="display: none;">
                            <div class="load-3">
                                <div class="line"></div>
                                <div class="line"></div>
                                <div class="line"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex flex-column align-items-center align-self-center">
                    <button class="btn btn-primary btn-lg mt-4" onclick="ApplyIntrusion()">Apply Intrusion</button>
                    <div class="d-flex justify-content-center my-3">
                        <div class="" id="loadingSpinner" style="display: none;">
                            <div class="load-3">
                                <div class="line"></div>
                                <div class="line"></div>
                                <div class="line"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 d-flex flex-column align-items-center">
                    <h2 class="fs-5 text-center">Image Intrusion:</h2>
                    <div class="image-container placeholder d-flex justify-content-center" style="width: 200px; height: 200px; overflow: hidden;">
                        <img id="preview2" src="static/img/noimg.png" alt="Intrusion image preview" style="width: 100%; height: 100%; object-fit: cover;" class="img-fluid">
                    </div>
                    <div id="prediction-result" class="m-2"></div>
                    <div id="prediction-result-intrusion" class="m-2"></div>
                    <div id="intrusion-error-message" class="text-danger mt-2" style="display: none;"></div>
                    <div class="d-flex justify-content-center my-3">
                        <div class="" id="loadingSpinnerDefence" style="display: none;">
                            <div class="load-3">
                                <div class="line"></div>
                                <div class="line"></div>
                                <div class="line"></div>
                            </div>
                        </div>
                    <!-- 
                        This HTML code represents the index page template for the Image Perturbation for Visual Security Enhancement project.
                        It contains a main container with two rows of buttons for predicting results and predicting with a defense model.
                        The buttons are styled using Bootstrap classes and have corresponding onclick event handlers.
                    -->
                    <div class="container">
                        <div class="row mt-5">
                            <div class="col-md-12 text-center">
                                <h1>Image Perturbation for Visual Security Enhancement</h1>
                            </div>
                        </div>
                        <div class="row mt-5">
                            <div class="col-md-12 text-center">
                                <h3>Upload an image to predict the result</h3>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12 text-center">
                                <input type="file" id="imageUpload" accept=".jpg, .jpeg, .png" />
                            </div>
                        </div>
                        <div class="row mt-1 d-flex justify-content-center">
                            <div class="col-md-6 text-center d-flex justify-content-center">
                                <button class="btn btn-primary btn-lg" onclick="predictResult()">Predict Result</button>
                            </div>
                            <div class="col-md-6 text-center d-flex justify-content-center pl-5">
                                <button class="btn btn-primary btn-lg " onclick="Predict_With_Intrusion()">Predict with defence model</button>
                            </div>
                        </div>
                    </div>
                    <main>
    
    <footer class="text-center mt-4">
        <p>SE4AI 2023/2024 - Luigi Emanuele Sica & Alessia Ture</p>
    </footer>
    <!--
        This script contains functions related to image preview, range input, alerts, and setting default labels.
        
        Functions:
        - oninput: Updates the value of a range input element and displays it.
        - previewImage: Displays a preview of the selected image and handles error messages.
        - showAlert: Displays a custom alert message.
        - removeAlert: Removes the custom alert message.
        - change event listener: Marks the sign select element as touched and removes the alert message.
        - setDefaultLabel: Sets the default label of the sign select element based on a prediction.
    -->
    <script>
        document.getElementById("range").oninput = function() {
            document.getElementById("range-value").innerHTML = this.value;
        }

        function previewImage(inputId, previewId) {
            var preview = document.getElementById(previewId);
            var file = document.getElementById(inputId).files[0];
            var reader = new FileReader();
            var errorMessage = document.getElementById("error-message");

            reader.onloadend = function() {
                preview.src = reader.result;
                preview.classList.remove('placeholder'); // Rimuove la classe placeholder quando l'immagine viene caricata
                errorMessage.style.display = "none";
            }

            if (file) {
                reader.readAsDataURL(file);
            } else {
                preview.src = "placeholder_gray.png"; // Se non viene selezionata alcuna immagine, visualizza il placeholder
                preview.classList.add('placeholder'); // Aggiunge la classe placeholder
            }
        }

        function showAlert(message) {
            var alertContainer = document.createElement("div");
            alertContainer.className = "alert alert-warning alert-dismissible fade show";
            alertContainer.role = "alert";
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            `;
            alertContainer.id = "custom-alert";
            document.body.appendChild(alertContainer);
        }

        function removeAlert() {
            var alertContainer = document.getElementById("custom-alert");
            if (alertContainer) {
                alertContainer.remove();
            }
        }

        var signSelect = document.getElementById("signs");
        var isSignSelectTouched = false;

        signSelect.addEventListener('change', function() {
            isSignSelectTouched = true;
            removeAlert();
        });

        function setDefaultLabel(prediction) {
            var signSelect = document.getElementById("signs");
            var predictionLabel = prediction.split(",")[1].trim().slice(1, -2); // Extract the label from "(index, 'label')"
            console.log('Prediction:', prediction);
            console.log('Prediction Label:', predictionLabel);
            console.log('Sign options:', signSelect.options);
            for (var i = 0; i < signSelect.options.length; i++) {
                console.log('Option value:', signSelect.options[i].value);
                if (signSelect.options[i].value === predictionLabel) {
                    signSelect.selectedIndex = i;
                    isSignSelectTouched = true;
                    removeAlert();
                    console.log('Default label set to:', predictionLabel);
                    break;
                }
            }
        }

        /**
         * Applies intrusion to an image and updates the HTML with the perturbed image and prediction result.
         * @function ApplyIntrusion
         */
        function ApplyIntrusion() {
            // Code implementation...
        }
        function ApplyIntrusion() {
            var fileInput = document.getElementById("image1");
            var errorMessage = document.getElementById("error-message");
            var loadingSpinner = document.getElementById('loadingSpinner');
            var intrusionErrorMessage = document.getElementById("intrusion-error-message");
            
            // Controlla se è stata caricata un'immagine
            if (!fileInput.files || !fileInput.files[0]) {
                errorMessage.style.display = 'block';
                errorMessage.innerText = 'Please upload an image before proceeding.';
                return; // Interrompe l'esecuzione della funzione se non c'è un'immagine
            } else {
                errorMessage.style.display = "none"; // Nasconde il messaggio di errore se è presente un'immagine perturbata
            }

            // Controlla se il segnale selezionato è il primo della lista e se il select è stato toccato
            var signIndex = document.getElementById("signs").selectedIndex;
            if (!isSignSelectTouched && signIndex == 0) {
                showAlert('Please make sure to select the correct label for the first sign.');
                return; // Interrompe l'esecuzione della funzione se il segnale è il primo della lista e non è stato toccato
            }
            
            errorMessage.style.display = 'none'; // Nasconde il messaggio di errore se l'immagine è presente
            loadingSpinner.style.display = 'block'; // Mostra il caricamento
            intrusionErrorMessage.style.display = 'none'; // Nasconde il messaggio di errore dell'intrusione

            var label = document.getElementById("signs").value;
            var formData = new FormData();
            var perturbation =  document.getElementById("range").value;
            
            formData.append("signIndex", signIndex);
            formData.append("label", label);
            formData.append("image1", fileInput.files[0]);
            formData.append("add_pertubation", perturbation);

            fetch('/applyIntrusion', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Se la risposta è OK, aggiorna l'immagine nell'HTML
                if (response.ok) {
                    // Leggi il percorso dell'immagine dalla risposta JSON
                    return response.json();
                } else {
                    console.error('Response not OK');
                }
            })
            .then(data => {
                // Aggiungi un timestamp all'URL per evitare la cache del browser
                var newImageUrl = data.image_url + "?t=" + new Date().getTime();
                
                // Visualizza l'immagine nell'HTML
                document.getElementById("preview2").src = newImageUrl;
                // Aggiorna il risultato della previsione nell'HTML
                document.getElementById('prediction-result').innerText = "Prediction with Intrusion: " + data.prediction;

                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                loadingSpinner.style.display = 'none';
            });
        }

        /**
         * Function to predict with intrusion.
         * 
         * This function retrieves the intrusion image, checks if it is present, and then sends a POST request to the server for prediction.
         * If the intrusion image is not present, an error message is displayed.
         * After receiving the prediction result, it updates the UI accordingly.
         */
        function Predict_With_Intrusion() {
            // Retrieve the intrusion image, error message, and loading spinner elements
            var intrusionImage = document.getElementById("preview2");
            var errorMessage = document.getElementById("intrusion-error-message");
            var loadingSpinner = document.getElementById('loadingSpinnerDefence');

            // Check if an intrusion image is present
            if (!intrusionImage.src || intrusionImage.src === "" || intrusionImage.src.endsWith("noimg.png")) {
                errorMessage.innerText = "Please apply an intrusion before predicting with defense model.";
                errorMessage.style.display = "block";
                return; // Interrupt the function execution if no intrusion image is present
            }

            errorMessage.style.display = "none"; // Hide the error message if an intrusion image is present
            loadingSpinner.style.display = 'block'; // Show the loading spinner

            var formData = new FormData();

            // Send a POST request to the server for prediction
            fetch('/predictWhitIntrusion', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                // Update the UI with the prediction result
                document.getElementById('prediction-result-intrusion').innerText = "Prediction Defence Model: " + data;
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                loadingSpinner.style.display = 'none';
            });
        }

        /**
         * Function to predict the result based on the uploaded image.
         */
        function predictResult() {
            var fileInput = document.getElementById("image1");
            var errorMessage = document.getElementById("error-message");
            var loadingSpinner = document.getElementById('loadingSpinnerPredictionBase');
            
            // Check if an image has been uploaded
            if (!fileInput.files || !fileInput.files[0]) {
                errorMessage.style.display = 'block';
                errorMessage.innerText = 'Please upload an image before proceeding.';
                return; // Stop the function execution if no image is present
            } else {
                errorMessage.style.display = "none"; // Hide the error message if a perturbed image is present
            }
            
            errorMessage.style.display = 'none'; // Hide the error message if the image is present
            loadingSpinner.style.display = 'block'; // Show the loading spinner
            
            var formData = new FormData();
            formData.append("image1", fileInput.files[0]);
            
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('prediction-result-base').innerText = "Prediction: " + data; 
                setDefaultLabel(data); // Set the prediction as the default label
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                loadingSpinner.style.display = 'none';
            });
        }
    </script>
</body>
</html>
